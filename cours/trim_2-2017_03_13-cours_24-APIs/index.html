<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>TRIM 2 - Cours 24 - PHP routing</title>
        <meta name="description" content="">
        <meta name="author" content="Bruno Simon">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="../src/reveal.js/css/reveal.css">
        <link rel="stylesheet" href="../src/reveal.js/css/theme/orange.css" id="theme">
        <link rel="stylesheet" href="../src/reveal.js/lib/css/highlight/railscasts.css">
        <!-- <link rel="stylesheet" href="../src/reveal.js/lib/css/highlight/github.css"> -->
        <link rel="stylesheet" href="../src/custom/style.css">
        <script>
            document.write( '<link rel="stylesheet" href="../src/reveal.js/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
        </script>
        <!--[if lt IE 9]>
            <script src="../src/reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h3>H2 - P2020</h3>
                    <h1>Développement web</h1>
                    <h3>Cours 24 - 2017-03-13</h3>
                    <ul>
                        <li>github : <a target="_blank" href="https://github.com/brunosimon/hetic-p2020">https://github.com/brunosimon/hetic-p2020</a></li>
                        <li>site : <a target="_blank" href="http://bruno-simon.com/hetic/p2020/">http://bruno-simon.com/hetic/p2020/</a></li>
                        <li>contact : <a target="_blank" mailto="bruno.simon@hetic.net">bruno.simon@hetic.net</a></li>
                    </ul>
                </section>

                <section>
                    <h3>PHP</h3>
                    <h1 class="default">APIs</h1>
                </section>

                <section>
                    <p>Application Programming Interface</p>
                </section>

                <section>
                    <p>
                        Définition général :
                        <br>Ensemble de classes, méthodes et fonctions d'un service
                    </p>
                    <p>
                        Définition web :
                        <br>Interface de communication d'un service web accessible par protocole HTTP
                    </p>
                </section>

                <section>
                    <p>Si vous avez créé un site et que vous souhaitez ouvrir vos données sans avoir à fournir trop d'accès et en gardant le contrôle sur les flux, vous pouvez mettre en place une API</p>
                </section>

                <section>
                    <p>Il en existe de très nombreuses et tous les grands en ont une&nbsp;:</p>
                    <ul>
                        <li><a href="https://developers.google.com/apis-explorer/" target="_blank">Google</a></li>
                        <li><a href="https://developers.facebook.com/docs/graph-api" target="_blank">Facebook</a></li>
                        <li><a href="https://dev.twitter.com/rest/public" target="_blank">Twitter</a></li>
                        <li><a href="https://www.instagram.com/developer/" target="_blank">Instagram</a></li>
                        <li><a href="https://www.flickr.com/services/api/" target="_blank">Flickr</a></li>
                        <li><a href="https://www.tumblr.com/docs/en/api/v2" target="_blank">Tumblr</a></li>
                        <li>...</li>
                    </ul>
                </section>

                <section>
                    <p>Les petits aussi :</p>
                    <ul>
                        <li><a href="http://openweathermap.org/api" target="_blank">OpenWeatherMap</a> (Météo)</li>
                        <li><a href="http://www.last.fm/api" target="_blank">LastFM</a> (Musique)</li>
                        <li><a href="https://data.police.uk" target="_blank">UK Police</a> (UK Police)</li>
                        <li><a href="https://api.nasa.gov" target="_blank">NASA</a> (Astronomie)</li>
                        <li><a href="http://api.football-data.org" target="_blank">Football-data</a> (Football)</li>
                        <li><a href="http://opendata.paris.fr/api/v1/documentation" target="_blank">Open Data Paris</a> (Paris)</li>
                        <li><a href="http://www.brewerydb.com/developers" target="_blank">Brewery DB</a> (Bières)</li>
                        <li><a href="http://pokeapi.co/" target="_blank">Poké API</a> (Pokemons)</li>
                        <li><a href="http://avatars.adorable.io/" target="_blank">Adorable Avatars</a> (Image d'avatar)</li>
                        <li><a href="https://github.com/toddmotto/public-apis" target="_blank">Et bien d'autres</a></li>
                    </ul>
                </section>

                <section>
                    <h2>Formats</h2>
                </section>

                <section>
                    <p>Les données renvoyées peuvent être dans différents formats</p>
                    <ul>
                        <li>JSON</li>
                        <li>XML</li>
                        <li>Images</li>
                        <li>Excel</li>
                        <li>PDF</li>
                        <li>...</li>
                    </ul>
                </section>

                <section>
                    <h2>Documentation</h2>
                </section>

                <section>
                    <ul>
                        <li>Chaque API est en général accompagnée d'une documentation</li>
                        <li>Elles ne sont pas toujours au top</li>
                        <li>Explorez intégralement la documentation avant de commencer</li>
                        <li>Si vous développez une API, ne négligez pas la documentation</li>
                    </ul>
                </section>

                <section>
                    <h2>Limites</h2>
                </section>

                <section>
                    <ul>
                        <li>La majorité des APIs possède des limites. Cela permet d'empêcher les abus et une surcharge du serveur.</li>
                        <li>Renseignez-vous sur ces limites et minimisez le nombre d'appels</li>
                        <li>Une bonne astuce consiste à utiliser du cache</li>
                    </ul>
                </section>

                <section>
                    <h2>REST</h2>
                </section>

                <section>
                    <p>Certaines APIs sont qualifiées de REST (Representational State Transfer)</p>
                    <ul>
                        <li>URI</li>
                        <li>HTTP</li>
                        <li>MIME types</li>
                        <li>Liens de transition inter-ressource</li>
                    </ul>
                </section>

                <section>
                    <h3>URI</h3>
                    <p>Dans une URL, il s'agit du chemin après le domaine : http://mon-api.com<span class="hl">/ressource/categorie/3/id/1827</span></p>
                    <p>L'URI permet d'identifier la ressource et doit être bien prévue avec une architecture logique et compréhensible</p>
                </section>

                <section>
                    <h3>HTTP</h3>
                    <p>Dans le cadre d'une API Rest, le choix du protocole permet de définir l'action désirée.</p>
                    <p>Nous connaissons deux protocoles GET et POST, Il en existe deux autres principaux, PUT et DELETE</p>
                    <ul>
                        <li>GET : Récupérer une ressource</li>
                        <li>POST : Ajouter une ressource</li>
                        <li>PUT : Modifier une ressource</li>
                        <li>DELETE : Supprimer une ressource</li>
                    </ul>
                </section>

                <section>
                    <h3>MIME Types</h3>
                    <p>Les APIs peuvent renvoyer du JSON, des images, du HTML, des excel, etc.</p>
                    <p>Lorsque la donnée est renvoyée, elle doit être accompagnée d'un MIME Type permettant d'indiquer clairement le type</p>
                    <p><a href="http://www.sitepoint.com/web-foundations/mime-types-complete-list/" target="_blank">Liste des mime types</a></p>
                </section>

                <section>
                    <h3>Liens de transition inter-ressource</h3>
                    <p>Pour être considérée comme REST, l'API doit renvoyer de données en fournissant les URI permettant d'accéder aux données voisines</p>
                    <p>Si par exemple on récupère une catégorie et que celle-ci renvoie des ressources, les URI de ces ressources doivent être indiquée. Cela permet aux développeur de facilement aller récupérer les ressources après avoir récupérer la catégorie.</p>
                </section>

                <section>
                    <h3>Bonus</h3>
                    <p>Moins officiellement, on considère une API comme REST dans ces deux conditions :</p>
                    <ul>
                        <li><span class="hl">ID</span> : Chaque ressource est identifiée de façon unique avec un ID</li>
                        <li><span class="hl">Stateless</span> : Une URI doit toujours renvoyer le même résultat (sauf si la donnée a changé). Il ne peut pas  y avoir de flux d'actions.</li>
                    </ul>
                </section>

                <section>
                    <h2>Communiquer avec une API</h2>
                </section>

                <section>
                    <p>Nous allons prendre comme exemple l'API de météo <a href="http://openweathermap.org/api" target="_blank">OpenWeatherMap</a></p>
                    <p>Comme de nombreuses APIs, celle-ci nécessite de s'enregistrer afin d'optenir une <span class="hl">API KEY</span>.<br>Il faudra envoyer cette API KEY avec chaque requête</p>
                    <pre><code contenteditable class="html">
API KEY : 9e8150c9d6fbf87d678d2cf7f7a2c00a
                    </code></pre>
                </section>

                <section>
                    <p>L'API de OpenWeatherMap est gratuite jusqu'à certaines limites</p>
                    <p><img src="src/img/openweathermap-limits.png" alt="" width="700"></p>
                </section>

                <section>
                    <h2>Communiquer avec une API</h2>
                    <h3>Dans le navigateur</h3>
                </section>

                <section>
                    <p>Puisque les APIs sont accessibles en HTTP via des URLs, on peut les tester directement depuis n'importe quel navigateur</p>
                    <p>Tapez l'URL suivante dans votre navigateur</p>
                    <pre><code contenteditable class="html">
http://api.openweathermap.org/data/2.5/weather?q=Paris&APPID=9e8150c9d6fbf87d678d2cf7f7a2c00a
                    </code></pre>
                    <p><img src="src/img/json-non-formated-chrome.png" alt="" width="700"></p>
                </section>

                <section>
                    <p>L'API de OpenWeatherMap renvoie du JSON</p>
                    <p>Pour formater le JSON dans Chrome, installez le plugin <a href="https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc" target="_blank">JSONView</a></p>
                    <p><img src="src/img/json-formated-chrome.png" alt="" width="340"></p>
                </section>

                <section>
                    <p>En tapant des URL dans votre navigateur, vous ne pouvez envoyer que des requêtes en GET</p>
                    <p>Pour envoyer des requêtes en POST, DELETE, PUT, etc., installez l'application Chrome <a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop" target="_blank">Postman</a></p>
                    <p><img src="src/img/postman.png" alt="" width="640"></p>
                </section>

                <section>
                    <p>Postman</p>
                    <ul>
                        <li>Gestion des paramètres</li>
                        <li>Headers</li>
                        <li>Historique</li>
                        <li>Sauvegarde</li>
                        <li>Organisation</li>
                        <li>Testing</li>
                        <li>...</li>
                    </ul>
                </section>

                <section>
                    <h2>Communiquer avec une API</h2>
                    <h3>En JS</h3>
                </section>

                <section>
                    <p>En JS natif</p>
                    <pre><code contenteditable class="js">
// Instanciate request
var xhr = new XMLHttpRequest();

// Ready stage change callback
xhr.onreadystatechange = function()
{
    // Is done
    if( xhr.readyState === XMLHttpRequest.DONE )
    {
        // Success
        if(xhr.status === 200)
        {
            var result = JSON.parse( xhr.responseText );
            console.log( 'success' );
            console.log( result );
        }
        else
        {
            console.log( 'error' );
        }
    }
};

// Open request
xhr.open( 'GET', 'http://api.openweathermap.org/data/2.5/weather?q=Paris&APPID=9e8150c9d6fbf87d678d2cf7f7a2c00a', true );

// Send request
xhr.send();
                    </code></pre>
                </section>

                <section>
                    <p>Avec jQuery</p>
                    <pre><code contenteditable class="js">
$.getJSON(
    'http://api.openweathermap.org/data/2.5/weather?q=Paris&APPID=9e8150c9d6fbf87d678d2cf7f7a2c00a',
    function( data )
    {
        console.log(data);
    }
);
                    </code></pre>
                </section>

                <section>
                    <p>Problèmes :</p>
                    <ul>
                        <li>Votre API KEY est visible et n'importe qui pourra la récupérer</li>
                        <li>Ce sont les visiteurs qui vont faire les requêtes directement depuis leur navigateur avec leur connexion</li>
                        <li>Pour 100 utilisateurs différents, la même requête sera exécutée 100 fois</li>
                    </ul>
                </section>

                <section>
                    <h2>Communiquer avec une API</h2>
                    <h3>En PHP</h3>
                </section>

                <section>
                    <p>Avec <a href="http://php.net/manual/fr/function.curl-init.php" target="_blank">CURL</a></p>
                    <pre><code contenteditable class="php">
// Instantiate curl
$curl = curl_init();
curl_setopt($curl, CURLOPT_URL, 'http://api.openweathermap.org/data/2.5/weather?q=Paris&APPID=9e8150c9d6fbf87d678d2cf7f7a2c00a');
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
$result = curl_exec($curl);
curl_close($curl);

// Json decode
$result = json_decode($result);

// Show result
echo '<pre>';
print_r($result->weather[0]->description);
echo '</pre>';
                    </code></pre>
                </section>

                <section>
                    <p>Avec <a href="http://php.net/manual/fr/function.file-get-contents.php" target="_blank">file_get_contents</a></p>
                    <pre><code contenteditable class="php">
// Get content
$result = file_get_contents('http://api.openweathermap.org/data/2.5/weather?q=Paris&APPID=9e8150c9d6fbf87d678d2cf7f7a2c00a');

// Json decode
$result = json_decode($result);

// Show result
echo '<pre>';
print_r($result->weather[0]->description);
echo '</pre>';
                    </code></pre>
                    <p>Attention, certains serveurs limitent l'utilisation de file_get_contents à des fichiers locaux</p>
                </section>

                <section>
                    <p>Avantages</p>
                    <ul>
                        <li>Possibilité de mettre en cache les requêtes</li>
                        <li>Possibilité de sauvegarder les données dans une BDD</li>
                        <li>Requêtes en général plus rapide</li>
                        <li>Les visiteurs ne voient rien (API KEY)</li>
                    </ul>
                </section>

            </div>
        </div>

        <script src="../src/reveal.js/lib/js/head.min.js"></script>
        <script src="../src/reveal.js/js/reveal.js"></script>
        <script src="../src/custom/script.js"></script>
    </body>
</html>
